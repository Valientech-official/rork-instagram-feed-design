# おすすめアルゴリズム設計書

**作成日**: 2025年11月10日
**対象アプリ**: Piece（ファッションSNS）
**バージョン**: 1.0

---

## 目次

1. [概要](#概要)
2. [アルゴリズムの種類](#アルゴリズムの種類)
3. [スコアリング要素と重み](#スコアリング要素と重み)
4. [推薦対象](#推薦対象)
5. [データベース設計](#データベース設計)
6. [APIエンドポイント](#apiエンドポイント)
7. [実装関数](#実装関数)
8. [パフォーマンス最適化](#パフォーマンス最適化)

---

## 概要

本ドキュメントは、Pieceアプリにおける推薦システムの設計を定義する。
ファッションSNSの特性を考慮し、ユーザーの興味・行動履歴に基づいた
パーソナライズされた推薦を提供する。

### 設計方針

- **ハイブリッドアプローチ**: コンテンツベース + 協調フィルタリング
- **リアルタイム性**: ユーザー行動を即座に反映
- **多様性**: 同じような推薦ばかりにならないようバランスを取る
- **プライバシー**: ユーザーデータを適切に管理

---

## アルゴリズムの種類

### 1. コンテンツベースフィルタリング（60%）

ユーザーの過去の行動や興味に基づいて、類似したコンテンツを推薦。

**メリット**:
- 新規ユーザーでも利用可能
- 個々のユーザー特性を反映しやすい

**実装方法**:
- カテゴリマッチング
- ハッシュタグの類似度
- スタイル属性の一致

### 2. 協調フィルタリング（30%）

似た興味を持つユーザーの行動を参考に推薦。

**メリット**:
- 新しい発見がある
- 予想外の良い推薦が生まれる

**実装方法**:
- フォロワーの「いいね」した投稿
- 類似ユーザーの閲覧履歴
- 共通フォロワー数

### 3. 人気度ベース（10%）

トレンドや人気コンテンツを混在させる。

**メリット**:
- 話題のコンテンツを見逃さない
- コールドスタート問題の緩和

**実装方法**:
- エンゲージメント率
- 急上昇中のコンテンツ
- 時系列での人気度

---

## スコアリング要素と重み

### タイムライン投稿推薦

| 要素 | 重み | 説明 |
|------|------|------|
| ユーザーの興味カテゴリ一致 | 35% | ユーザーがよく見るカテゴリ |
| フォロー中ユーザーの投稿 | 25% | フォローしているユーザーの投稿を優先 |
| 人気度（いいね・コメント数） | 15% | エンゲージメントが高い投稿 |
| 新鮮度（投稿時間） | 15% | 新しい投稿を優先 |
| 過去の類似投稿への反応 | 10% | 過去にいいねした投稿と類似 |

**計算式**:
```
スコア = (カテゴリ一致度 × 0.35) + (フォロー関係 × 0.25) +
         (人気度 × 0.15) + (新鮮度 × 0.15) + (類似度 × 0.10)
```

### Room推薦

| 要素 | 重み | 説明 |
|------|------|------|
| ユーザーの参加履歴カテゴリ | 40% | 過去に参加したRoomのカテゴリ |
| アクティブメンバー数 | 25% | 活発なRoomを優先 |
| 投稿頻度 | 15% | 定期的に投稿があるRoom |
| フォロワーの参加状況 | 10% | フォロワーが参加しているRoom |
| 新規作成Room優先 | 10% | 新しくできたRoomも紹介 |

### 商品推薦

| 要素 | 重み | 説明 |
|------|------|------|
| 閲覧・いいね履歴カテゴリ | 35% | 過去に興味を示したカテゴリ |
| 価格帯の一致 | 20% | ユーザーの好む価格帯 |
| トレンド度 | 20% | 今話題の商品 |
| 販売実績 | 15% | クリック数が多い商品 |
| フォロワーの購入傾向 | 10% | フォロワーが見ている商品 |

### ユーザー推薦

| 要素 | 重み | 説明 |
|------|------|------|
| 共通フォロワー数 | 30% | 共通の友人が多い |
| 興味カテゴリの類似度 | 25% | 似た興味を持っている |
| アクティビティレベル | 20% | 活発に投稿しているユーザー |
| 相互フォロー確率 | 15% | フォローバックしやすいユーザー |
| 投稿内容の類似度 | 10% | 投稿スタイルが似ている |

### ハッシュタグ推薦

| 要素 | 重み | 説明 |
|------|------|------|
| ユーザーの使用履歴 | 35% | 過去に使ったハッシュタグ |
| トレンド度 | 30% | 今使われているハッシュタグ |
| 関連ハッシュタグ | 20% | 類似・関連するハッシュタグ |
| フォロワーの使用頻度 | 15% | フォロワーがよく使うハッシュタグ |

---

## 推薦対象

1. **タイムライン投稿** - ホームフィードに表示
2. **Room** - おすすめRoomセクション
3. **商品** - ショップページのおすすめ
4. **ユーザー** - フォロー推奨ユーザー
5. **ハッシュタグ** - 検索時の候補

---

## データベース設計

### USER_BEHAVIOR テーブル

ユーザーの行動履歴を記録。

| カラム名 | 型 | 説明 |
|---------|---|------|
| account_id | String (PK) | ユーザーID |
| behavior_id | String (SK) | 行動ID (timestamp + type) |
| behavior_type | String | 行動タイプ (like, comment, view, follow等) |
| target_id | String | 対象のID (投稿、商品、ユーザー等) |
| target_type | String | 対象のタイプ (post, product, user, room, hashtag) |
| timestamp | Number | 行動した時刻 (Unix秒) |
| weight | Number | 重み付け (1-10) |
| ttl | Number | 30日後に自動削除 |

**GSI**:
- `GSI1`: target_id (PK) + timestamp (SK) - 特定コンテンツへの反応を取得

### RECOMMENDATION_CACHE テーブル

推薦結果のキャッシュ。

| カラム名 | 型 | 説明 |
|---------|---|------|
| account_id | String (PK) | ユーザーID |
| recommendation_type | String (SK) | 推薦タイプ (timeline, room, product, user, hashtag) |
| recommended_items | List | 推薦アイテムのIDリスト |
| scores | List | 各アイテムのスコアリスト |
| updated_at | Number | 更新日時 |
| expires_at | Number (TTL) | 1時間後に自動削除 |

---

## APIエンドポイント

### 1. タイムライン推薦取得

```
GET /recommendation/timeline
```

**クエリパラメータ**:
- `limit` (optional): 取得件数 (デフォルト: 20)
- `nextToken` (optional): ページネーショントークン

**レスポンス**:
```json
{
  "items": [
    {
      "post_id": "...",
      "score": 0.85,
      ...
    }
  ],
  "scores": [0.85, 0.82, ...],
  "nextToken": "..."
}
```

### 2. Room推薦取得

```
GET /recommendation/rooms
```

**クエリパラメータ**: 同上

### 3. 商品推薦取得

```
GET /recommendation/products
```

**クエリパラメータ**:
- `limit`, `nextToken`
- `category` (optional): カテゴリフィルタ

### 4. ユーザー推薦取得

```
GET /recommendation/users
```

**クエリパラメータ**: 同上

### 5. ハッシュタグ推薦取得

```
GET /recommendation/hashtags
```

**クエリパラメータ**:
- `limit` (optional): 取得件数 (デフォルト: 10)

### 6. 行動トラッキング

```
POST /recommendation/track-behavior
```

**リクエストボディ**:
```json
{
  "behavior_type": "like",
  "target_id": "post_123",
  "target_type": "post",
  "weight": 5
}
```

---

## 実装関数

### フロントエンド (lib/recommendation/engine.ts)

#### 基本スコアリング関数

1. **calculateContentScore(item, userProfile)**
   - コンテンツとユーザープロフィールの一致度を計算
   - カテゴリ、ハッシュタグ、スタイル属性を比較
   - 戻り値: 0.0 ~ 1.0

2. **calculatePopularityScore(item)**
   - 人気度スコアを計算
   - いいね数、コメント数、シェア数を考慮
   - 戻り値: 0.0 ~ 1.0

3. **calculateFreshnessScore(item)**
   - 新鮮度スコアを計算
   - 投稿時刻からの経過時間で減衰
   - 戻り値: 0.0 ~ 1.0

4. **calculateSimilarityScore(item, userHistory)**
   - ユーザー履歴との類似度を計算
   - 過去の行動パターンと比較
   - 戻り値: 0.0 ~ 1.0

#### 統合スコアリング

5. **combineScores(scores, weights)**
   - 各スコアを重み付けして統合
   - 戻り値: 最終スコア (0.0 ~ 1.0)

6. **normalizeScores(scores)**
   - スコアを正規化 (min-max normalization)
   - 戻り値: 正規化されたスコア配列

#### ユーティリティ関数

7. **filterByCategory(items, categories)**
   - カテゴリでフィルタ

8. **deduplicateItems(items)**
   - 重複アイテムを除去

9. **shuffleWithinBuckets(items, bucketSize)**
   - スコア範囲内でランダムシャッフル（多様性のため）

### バックエンド (backend/src/handlers/recommendation/)

1. **getTimelineRecommendations.ts** - タイムライン推薦ハンドラー
2. **getRoomRecommendations.ts** - Room推薦ハンドラー
3. **getProductRecommendations.ts** - 商品推薦ハンドラー
4. **getUserRecommendations.ts** - ユーザー推薦ハンドラー
5. **getHashtagRecommendations.ts** - ハッシュタグ推薦ハンドラー
6. **trackBehavior.ts** - 行動トラッキングハンドラー

---

## パフォーマンス最適化

### 1. キャッシング戦略

- **RECOMMENDATION_CACHE テーブル**: 1時間のTTL
- **リアルタイム更新**: 重要な行動（いいね、フォロー）時にキャッシュ更新
- **段階的更新**: すべてを再計算せず、差分更新

### 2. バッチ処理

- **夜間バッチ**: 全ユーザーの推薦を事前計算
- **オンデマンド計算**: キャッシュミス時のみ計算

### 3. スコアリング最適化

- **早期終了**: スコアが低すぎる場合は計算をスキップ
- **並列処理**: 複数の推薦タイプを並列計算
- **インデックス活用**: DynamoDB GSIを効率的に利用

### 4. データ削減

- **行動履歴の TTL**: 30日で自動削除
- **重要度フィルタ**: 重み（weight）が低い行動は無視
- **サンプリング**: 大量データの場合はサンプリング

---

## 今後の拡張

1. **機械学習モデルの導入**
   - ニューラルネットワークによるスコアリング
   - A/Bテストでの効果検証

2. **リアルタイムパーソナライゼーション**
   - セッション内での動的調整
   - 時間帯による推薦の変化

3. **多様性の向上**
   - フィルターバブル対策
   - セレンディピティの導入

4. **フィードバックループ**
   - 推薦クリック率の追跡
   - スコアリング重みの自動調整

---

**END OF DOCUMENT**
